<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Seguro - Sistema de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .secure-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .secure-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .master-key-section {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .password-toggle {
            cursor: pointer;
            border: none;
            background: transparent;
            outline: none;
        }
        .password-toggle:hover {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="secure-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card secure-card">
                        <div class="card-body p-5">
                            <!-- Logo y Título -->
                            <div class="text-center mb-4">
                                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                                <h3 class="card-title">Registro Seguro</h3>
                                <p class="text-muted">Acceso autorizado requerido</p>
                            </div>

                            <!-- Alertas -->
                            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span th:text="${error}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>

                            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle"></i>
                                <span th:text="${success}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>

                            <div th:if="${info}" class="alert alert-info alert-dismissible fade show" role="alert">
                                <i class="fas fa-info-circle"></i>
                                <span th:text="${info}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>

                            <!-- Formulario de Clave Maestra -->
                            <div th:if="${showMasterKeyForm == true}">
                                <div class="master-key-section">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-key fa-2x me-3"></i>
                                        <div>
                                            <h6 class="mb-0">Verificación de Acceso</h6>
                                            <small>Se requiere clave maestra para registrar usuarios</small>
                                        </div>
                                    </div>
                                </div>

                                <form th:action="@{/secure-register/verify}" method="post" id="masterKeyForm">
                                    <div class="mb-3">
                                        <label for="masterKeyInput" class="form-label">
                                            <i class="fas fa-lock"></i> Clave Maestra *
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" 
                                                   id="masterKeyInput" name="masterKeyInput" 
                                                   placeholder="Ingrese la clave de autorización" 
                                                   required
                                                   th:value="${masterKeyInput}">
                                            <button type="button" class="btn btn-outline-secondary password-toggle" 
                                                    id="toggleMasterKey" title="Mostrar/ocultar clave maestra">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-key"></i> Verificar Clave Maestra
                                        </button>
                                        <a th:href="@{/login}" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left"></i> Volver al Login
                                        </a>
                                    </div>
                                </form>
                            </div>

                            <!-- Formulario de Registro -->
                            <div th:if="${showMasterKeyForm == false}">
                                <div class="master-key-section">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-check-circle fa-2x me-3"></i>
                                        <div>
                                            <h6 class="mb-0">Clave Maestra Verificada</h6>
                                            <small>Complete la información del nuevo usuario</small>
                                        </div>
                                    </div>
                                </div>

                                <form th:action="@{/secure-register/register}" method="post" id="registerForm" th:object="${usuario}">
                                    <h6 class="mb-3">
                                        <i class="fas fa-user-plus"></i> Información del Nuevo Usuario
                                    </h6>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="username" class="form-label">Usuario *</label>
                                            <input type="text" class="form-control" 
                                                   id="username" name="username" 
                                                   th:field="*{username}"
                                                   required 
                                                   placeholder="Nombre de usuario"
                                                   th:value="${usuario != null ? usuario.username : ''}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="email" class="form-label">Email *</label>
                                            <input type="email" class="form-control" 
                                                   id="email" name="email" 
                                                   th:field="*{email}"
                                                   required 
                                                   placeholder="correo@ejemplo.com"
                                                   th:value="${usuario != null ? usuario.email : ''}">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="nombreCompleto" class="form-label">Nombre Completo *</label>
                                        <input type="text" class="form-control" 
                                               id="nombreCompleto" name="nombreCompleto" 
                                               th:field="*{nombreCompleto}"
                                               required 
                                               placeholder="Nombre completo del usuario"
                                               th:value="${usuario != null ? usuario.nombreCompleto : ''}">
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="passwordHash" class="form-label">Contraseña *</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" 
                                                       id="passwordHash" name="passwordHash" 
                                                       th:field="*{passwordHash}"
                                                       required 
                                                       placeholder="Contraseña"
                                                       th:value="${usuario != null ? usuario.passwordHash : ''}">
                                                <button type="button" class="btn btn-outline-secondary password-toggle" 
                                                        id="togglePasswordHash" title="Mostrar/ocultar contraseña">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                Mínimo 6 caracteres
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="confirmPassword" class="form-label">Confirmar Contraseña *</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" 
                                                       id="confirmPassword" name="confirmPassword"
                                                       required 
                                                       placeholder="Repetir contraseña">
                                                <button type="button" class="btn btn-outline-secondary password-toggle" 
                                                        id="toggleConfirmPassword" title="Mostrar/ocultar contraseña">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label for="rolId" class="form-label">Rol del Usuario *</label>
                                        <select class="form-select" id="rolId" name="rolId" required>
                                            <option value="">Seleccionar rol...</option>
                                            <option th:each="rol : ${roles}" 
                                                    th:value="${rol.id}" 
                                                    th:text="${rol.nombre + ' (' + rol.codigo + ')'}"
                                                    th:selected="${usuario != null && usuario.rol != null && usuario.rol.id == rol.id}">
                                            </option>
                                        </select>
                                        <div class="form-text">
                                            <i class="fas fa-shield-alt"></i>
                                            Asigne los permisos adecuados según las responsabilidades
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-user-plus"></i> Registrar Usuario
                                        </button>
                                        <a th:href="@{/login}" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left"></i> Volver al Login
                                        </a>
                                    </div>
                                </form>
                            </div>

                            <!-- Información de Seguridad -->
                            <div class="mt-4 p-3 bg-light rounded">
                                <h6 class="mb-2">
                                    <i class="fas fa-info-circle text-info"></i> Información de Seguridad
                                </h6>
                                <small class="text-muted">
                                    • Solo el personal autorizado debe usar esta función<br>
                                    • La clave maestra es confidencial<br>
                                    • Todos los registros son auditados<br>
                                    • Las contraseñas se almacenan encriptadas<br>
                                    • Los usuarios nuevos deben cambiar su contraseña en el primer acceso
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Función para mostrar/ocultar contraseña
            function setupTogglePassword(buttonId, inputId) {
                const toggleButton = document.querySelector(buttonId);
                const input = document.querySelector(inputId);

                if (toggleButton && input) {
                    toggleButton.addEventListener('click', function () {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        
                        // Cambiar icono
                        const icon = this.querySelector('i');
                        if (type === 'text') {
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                            }
                    });
                }
            }

            // Configurar todos los botones de mostrar/ocultar
            setupTogglePassword('#toggleMasterKey', '#masterKeyInput');
            setupTogglePassword('#togglePasswordHash', '#passwordHash');
            setupTogglePassword('#toggleConfirmPassword', '#confirmPassword');

            // Validación de contraseñas
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', function(e) {
                    const password = document.getElementById('passwordHash');
                    const confirmPassword = document.getElementById('confirmPassword');
                    
                    if (password && confirmPassword) {
                        if (password.value !== confirmPassword.value) {
                            e.preventDefault();
                            alert('Las contraseñas no coinciden. Por favor, verifique.');
                            confirmPassword.focus();
                            return;
                        }

                        if (password.value.length < 6) {
                            e.preventDefault();
                            alert('La contraseña debe tener al menos 6 caracteres.');
                            password.focus();
                            return;
                        }
                    }
                    
                    // Validar que se haya seleccionado un rol
                    const rolSelect = document.getElementById('rolId');
                    if (rolSelect && rolSelect.value === "") {
                        e.preventDefault();
                        alert('Por favor seleccione un rol para el usuario.');
                        rolSelect.focus();
                    }
                });
            }

            // Auto-focus en el campo de clave maestra
            const masterKeyInput = document.getElementById('masterKeyInput');
            if (masterKeyInput) {
                masterKeyInput.focus();
            }

            // Auto-rellenar clave maestra en desarrollo (opcional)
            // Descomenta las siguientes líneas solo para desarrollo local
            /*
            function fillMasterKey() {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    const masterKeyInput = document.getElementById('masterKeyInput');
                    if (masterKeyInput && !masterKeyInput.value) {
                        masterKeyInput.value = 'ClaveMaestra2024!';
                    }
                }
            }
            fillMasterKey();
            */
        });
    </script>
</body>
</html>
